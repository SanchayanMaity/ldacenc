/*
 * display ldac info
 *
 * url: https://github.com/eggman/ldacenc
 * licence: Apache License, Version 2.0
 */

#include <stdio.h>

#define DECLFUNC static
#define LDAC_NSFCWTBL          8
#define LDAC_MAXNQUS          34
#define LDAC_NIDWL            16
/***************************************************************************************************
    Tables related to Quantization Units
***************************************************************************************************/
DECLFUNC const unsigned char ga_idsp_ldac[LDAC_MAXNQUS] = {
      0,  0,  0,  0,  0,  0,  0,  0,
      1,  1,  1,  1,
      1,  1,  1,  1,
      1,  1,  1,  1,
      2,  2,
      2,  2,
      3,  3,
      3,  3,
      3,  3,
      3,  3,
      3,  3,
};

DECLFUNC const unsigned char ga_nsps_ldac[LDAC_MAXNQUS] = {
      2,  2,  2,  2,  2,  2,  2,  2,
      4,  4,  4,  4,
      4,  4,  4,  4,
      4,  4,  4,  4,
      8,  8,
      8,  8,
     16, 16,
     16, 16,
     16, 16,
     16, 16,
     16, 16,
};

DECLFUNC const unsigned short ga_isp_ldac[LDAC_MAXNQUS+1] = {
      0,  2,  4,  6,  8, 10, 12, 14,
     16, 20, 24, 28,
     32, 36, 40, 44,
     48, 52, 56, 60,
     64, 72,
     80, 88,
     96,112,
    128,144,
    160,176,
    192,208,
    224,240,
    256,
};

/***************************************************************************************************
    Encoding/Decoding Tables for Spectrum Data
***************************************************************************************************/
DECLFUNC const unsigned char ga_wl_ldac[LDAC_NIDWL] = {
    0,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
};

DECLFUNC const short gaa_ndim_wls_ldac[4][LDAC_NIDWL] = {
    {0,  3,  6,  8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32},
    {0,  7, 12, 16, 20, 24, 28, 32, 36, 40, 44, 48, 52, 56, 60, 64},
    {0, 14, 24, 32, 40, 48, 56, 64, 72, 80, 88, 96,104,112,120,128},
    {0, 28, 48, 64, 80, 96,112,128,144,160,176,192,208,224,240,256},
};



DECLFUNC const unsigned char gaa_sfcwgt_ldac[LDAC_NSFCWTBL][LDAC_MAXNQUS] = {
{
     1,  0,  0,  1,  1,  1,  2,  2,  2,  2,  2,  2,  3,  3,  3,  3,
     3,  3,  3,  3,  3,  3,  3,  4,  4,  5,  5,  6,  6,  7,  7,  8,  8,  8,
},
{
     0,  1,  1,  2,  3,  4,  4,  4,  4,  5,  6,  6,  6,  6,  6,  7,
     7,  7,  7,  7,  7,  7,  8,  8,  8,  9, 10, 10, 11, 11, 12, 12, 12, 12,
},
{
     0,  1,  1,  2,  3,  3,  3,  3,  3,  4,  4,  5,  5,  5,  5,  5,
     5,  5,  5,  5,  5,  5,  6,  6,  6,  7,  8,  9,  9, 10, 10, 11, 11, 11,
},
{
     0,  1,  3,  4,  5,  5,  6,  6,  6,  6,  7,  7,  7,  7,  7,  7,
     7,  7,  7,  7,  7,  7,  7,  8,  8,  8,  8,  9,  9,  9, 10, 10, 10, 10,
},
{
     0,  1,  3,  4,  5,  5,  6,  7,  7,  8,  8,  9,  9, 10, 10, 10,
    10, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 12, 13, 13, 13, 13, 13,
},
{
     1,  0,  1,  2,  2,  3,  3,  4,  4,  5,  6,  7,  7,  8,  8,  8,
     9,  9,  9,  9,  9, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11,
},
{
     0,  0,  1,  1,  2,  2,  2,  2,  2,  3,  3,  3,  3,  4,  4,  4,
     4,  4,  4,  4,  4,  4,  4,  5,  5,  6,  7,  7,  7,  8,  9,  9,  9,  9,
},
{
     0,  0,  1,  2,  3,  4,  4,  5,  5,  6,  7,  7,  8,  8,  8,  8,
     9,  9,  9,  9,  9, 10, 10, 10, 10, 11, 11, 11, 11, 12, 12, 12, 12, 12,
},
};


#define LDAC_MAXGRADQU        50
/***************************************************************************************************
    Resampled Gradient Table
***************************************************************************************************/
DECLFUNC const unsigned char gaa_resamp_grad_ldac[LDAC_MAXGRADQU][LDAC_MAXGRADQU] = {
{
128,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
 31,225,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
 17,128,239,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
 12, 69,187,244,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
 10, 43,128,213,246,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  9, 31, 87,169,225,247,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  8, 24, 62,128,194,232,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  8, 19, 47, 97,159,209,237,248,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  7, 17, 37, 75,128,181,219,239,249,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  7, 15, 31, 59,103,153,197,225,241,249,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  7, 13, 26, 48, 83,128,173,208,230,243,249,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6, 12, 23, 41, 69,107,149,187,215,233,244,250,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6, 11, 20, 35, 58, 90,128,166,198,221,236,245,250,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6, 11, 18, 31, 49, 76,110,146,180,207,225,238,245,250,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6, 10, 17, 27, 43, 66, 95,128,161,190,213,229,239,246,250,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6, 10, 15, 24, 38, 57, 82,112,144,174,199,218,232,241,246,250,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  9, 14, 22, 34, 50, 72, 98,128,158,184,206,222,234,242,247,250,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  9, 13, 20, 31, 45, 63, 87,114,142,169,193,211,225,236,243,247,250,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  9, 13, 19, 28, 40, 56, 77,101,128,155,179,200,216,228,237,243,247,250,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  8, 12, 18, 26, 36, 51, 69, 91,115,141,165,187,205,220,230,238,244,248,250,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  8, 12, 17, 24, 33, 46, 62, 81,104,128,152,175,194,210,223,232,239,244,248,250,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  6,  8, 11, 16, 22, 31, 42, 56, 74, 94,116,140,162,182,200,214,225,234,240,245,248,250,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  8, 11, 15, 21, 28, 38, 51, 67, 85,106,128,150,171,189,205,218,228,235,241,245,248,251,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  8, 10, 14, 19, 26, 35, 47, 61, 78, 97,117,139,159,178,195,209,221,230,237,242,246,248,251,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7, 10, 14, 18, 25, 33, 43, 56, 71, 88,108,128,148,168,185,200,213,223,231,238,242,246,249,251,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7, 10, 13, 17, 23, 31, 40, 51, 65, 81, 99,118,138,157,175,191,205,216,225,233,239,243,246,249,
251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  9, 13, 17, 22, 29, 37, 47, 60, 75, 91,109,128,147,165,181,196,209,219,227,234,239,243,247,
249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  9, 12, 16, 21, 27, 35, 44, 55, 69, 84,101,119,137,155,172,187,201,212,221,229,235,240,244,
247,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  9, 12, 15, 20, 25, 32, 41, 51, 64, 78, 94,110,128,146,162,178,192,205,215,224,231,236,241,
244,247,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  9, 11, 15, 19, 24, 31, 38, 48, 59, 72, 87,103,119,137,153,169,184,197,208,218,225,232,237,
241,245,247,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  9, 11, 14, 18, 23, 29, 36, 45, 55, 67, 81, 96,112,128,144,160,175,189,201,211,220,227,233,
238,242,245,247,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  8, 11, 14, 17, 22, 27, 34, 42, 52, 63, 75, 89,104,120,136,152,167,181,193,204,214,222,229,
234,239,242,245,248,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  8, 11, 13, 17, 21, 26, 32, 40, 48, 59, 70, 83, 98,113,128,143,158,173,186,197,208,216,224,
230,235,239,243,245,248,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  7,  8, 10, 13, 16, 20, 25, 31, 37, 46, 55, 66, 78, 91,106,120,136,150,165,178,190,201,210,219,
225,231,236,240,243,246,248,249,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8, 10, 12, 15, 19, 24, 29, 35, 43, 52, 62, 73, 86, 99,113,128,143,157,170,183,194,204,213,
221,227,232,237,241,244,246,248,250,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8, 10, 12, 15, 18, 23, 28, 34, 41, 49, 58, 69, 81, 93,107,121,135,149,163,175,187,198,207,
215,222,228,233,238,241,244,246,248,250,251,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8, 10, 12, 15, 18, 22, 26, 32, 39, 46, 55, 65, 76, 88,101,114,128,142,155,168,180,191,201,
210,217,224,230,234,238,241,244,246,248,250,251,255,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8,  9, 12, 14, 17, 21, 25, 31, 37, 44, 52, 61, 72, 83, 95,108,121,135,148,161,173,184,195,
204,212,219,225,231,235,239,242,244,247,248,250,251,255,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8,  9, 11, 14, 17, 20, 24, 29, 35, 42, 49, 58, 68, 78, 90,102,115,128,141,154,166,178,188,
198,207,214,221,227,232,236,239,242,245,247,248,250,251,255,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  8,  9, 11, 13, 16, 19, 23, 28, 33, 40, 47, 55, 64, 74, 85, 97,109,122,134,147,159,171,182,
192,201,209,216,223,228,233,237,240,243,245,247,248,250,251,255,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  7,  9, 11, 13, 16, 19, 22, 27, 32, 38, 44, 52, 61, 70, 80, 92,103,116,128,140,153,164,176,
186,195,204,212,218,224,229,234,237,240,243,245,247,249,250,251,255,255,255,255,255,255,255,255,255,
},
{
  5,  6,  7,  9, 11, 13, 15, 18, 22, 26, 31, 36, 42, 49, 58, 66, 76, 87, 98,110,122,134,146,158,169,
180,190,198,207,214,220,225,230,234,238,241,243,245,247,249,250,251,255,255,255,255,255,255,255,255,
},
{
  5,  6,  7,  9, 10, 12, 15, 18, 21, 25, 29, 34, 40, 47, 55, 63, 72, 82, 93,104,116,128,140,152,163,
174,184,193,201,209,216,222,227,231,235,238,241,244,246,247,249,250,251,255,255,255,255,255,255,255,
},
{
  5,  6,  7,  9, 10, 12, 14, 17, 20, 24, 28, 33, 39, 45, 52, 60, 69, 78, 89, 99,111,122,134,145,157,
167,178,187,196,204,211,217,223,228,232,236,239,242,244,246,247,249,250,251,255,255,255,255,255,255,
},
{
  5,  6,  7,  8, 10, 12, 14, 17, 20, 23, 27, 32, 37, 43, 50, 57, 66, 75, 84, 95,105,117,128,139,151,
161,172,181,190,199,206,213,219,224,229,233,236,239,242,244,246,248,249,250,251,255,255,255,255,255,
},
{
  5,  6,  7,  8, 10, 12, 14, 16, 19, 22, 26, 31, 36, 41, 48, 55, 62, 71, 80, 90,101,111,122,134,145,
155,166,176,185,194,201,208,215,220,225,230,234,237,240,242,244,246,248,249,250,251,255,255,255,255,
},
{
  5,  6,  7,  8, 10, 11, 13, 16, 18, 22, 25, 29, 34, 39, 45, 52, 60, 68, 77, 86, 96,106,117,128,139,
150,160,170,179,188,196,204,211,217,222,227,231,234,238,240,243,245,246,248,249,250,251,255,255,255,
},
{
  5,  6,  7,  8, 10, 11, 13, 15, 18, 21, 24, 28, 33, 38, 44, 50, 57, 65, 73, 82, 92,102,112,123,133,
144,154,164,174,183,191,199,206,212,218,223,228,232,235,238,241,243,245,246,248,249,250,251,255,255,
},
{
  5,  6,  7,  8,  9, 11, 13, 15, 17, 20, 24, 27, 32, 36, 42, 48, 55, 62, 70, 78, 88, 97,107,118,128,
138,149,159,168,178,186,194,201,208,214,220,224,229,232,236,239,241,243,245,247,248,249,250,251,255,
},
{
  5,  6,  7,  8,  9, 11, 13, 15, 17, 20, 23, 26, 31, 35, 40, 46, 52, 59, 67, 75, 84, 93,103,113,123,
133,143,153,163,172,181,189,197,204,210,216,221,225,230,233,236,239,241,243,245,247,248,249,250,251,
},
};



typedef struct {
    unsigned char code;
    unsigned char len;
} CODEBOOK;

typedef struct {
    const CODEBOOK *p_tbl;
    unsigned char ncodes;
    unsigned char codes_min_bits;
    unsigned char codes_max_bits;
} CODES;

static const CODEBOOK codebook[8] = {
    { 0, 2}, { 1, 2}, {14, 4}, {62, 6},
    {63, 6}, {30, 5}, { 6, 3}, { 2, 2},
};

static const CODES codes = {
    codebook, 8, 2, 6
};

static int g_sfc_weight;
static int g_nadjqus;
int g_a_idsf[LDAC_MAXNQUS];
int g_a_grad[LDAC_MAXNQUS];
int g_a_addwl[LDAC_MAXNQUS];
int g_a_idwl1[LDAC_MAXNQUS];
int g_a_idwl2[LDAC_MAXNQUS];

int read_bit(unsigned char *pdata, int pos)
{
    int bytepos = pos / 8;
    int bitpos  = pos % 8;
    return (pdata[bytepos] & (1 << (7 - bitpos))) ? 1 : 0;
}

int read_bits(unsigned char *pdata, int pos, int nbits)
{
    int tmp = 0;
    int p = pos;

	for (int i = 1; i <= nbits; i++) {
        tmp = tmp << 1;
	    tmp += read_bit(pdata, p);
        p++;
    }
    return tmp;
}

int dump_ldac_header(unsigned char *pdata, int pos)
{
    int syncword;

    syncword = read_bits(pdata, pos + 0, 8);
    if (syncword != 0xAA) {
        printf("not found syncword\n");
        return -1;
    }

    printf("HEADER\n");
    printf("  SYNCWORD   %02X\n", syncword);
    printf("  SAMPLERATE %02X\n", read_bits(pdata, pos +  8, 3));
    printf("  CHCONFIG   %02X\n", read_bits(pdata, pos + 11, 2));
    printf("  FRAMELEN   %02X\n", read_bits(pdata, pos + 13, 9));
    printf("  FRAMESTAT  %02X\n", read_bits(pdata, pos + 22, 2));
    printf("\n");

    return pos + 24;
}

int dump_ldac_bandinfo(unsigned char *pdata, int pos)
{
    printf("BANDINFO\n");
    printf("  NBAND      %02X\n", read_bits(pdata, pos + 0, 4));
    printf("  FLAG       %02X\n", read_bits(pdata, pos + 4, 1));
    printf("\n");

    return pos + 5;
}

int dump_ldac_gradient(unsigned char *pdata, int pos)
{
    int new_pos = pos;
    int grad_mode = read_bits(pdata, pos + 0, 2);

    printf("GRADIENT\n");
        printf("  GRADMODE   %02X\n", read_bits(pdata, pos + 0, 2));
    if (grad_mode == 0) {
        printf("  GRADQU0_L  %02X\n", read_bits(pdata, pos +  2, 6));
        printf("  GRADQU0_H  %02X\n", read_bits(pdata, pos +  8, 6));
        printf("  GRADOS_L   %02X\n", read_bits(pdata, pos + 14, 5));
        printf("  GRADOS_H   %02X\n", read_bits(pdata, pos + 19, 5));
        printf("  NADJQU     %02X\n", read_bits(pdata, pos + 24, 5));
        g_nadjqus = read_bits(pdata, pos + 24, 5);
        new_pos = pos + 29;

        int hqu = 24;
        int ich, iqu;
        int grad_qu_l = read_bits(pdata, pos +  2, 6);
        int grad_qu_h = read_bits(pdata, pos +  8, 6) + 1;
        int grad_os_l = read_bits(pdata, pos + 14, 5);
        int grad_os_h = read_bits(pdata, pos + 19, 5);
        int tmp = grad_qu_h - grad_qu_l;
        int *p_grad = g_a_grad;
        const unsigned char *p_t;

        /* Calculate Gradient Curve */
        for (iqu = 0; iqu < grad_qu_h; iqu++) {
            p_grad[iqu] = -grad_os_l;
        }
        for (iqu = grad_qu_h; iqu < hqu; iqu++) {
            p_grad[iqu] = -grad_os_h;
        }

        if (tmp > 0) {
            p_t = gaa_resamp_grad_ldac[tmp-1];

            tmp = grad_os_h - grad_os_l;
            if (tmp > 0) {
                tmp = tmp-1;
                for (iqu = grad_qu_l; iqu < grad_qu_h; iqu++) {
                    p_grad[iqu] -= ((*p_t++ * tmp) >> 8) + 1;
                }
            }
            else if (tmp < 0) {
                tmp = -tmp-1;
                for (iqu = grad_qu_l; iqu < grad_qu_h; iqu++) {
                    p_grad[iqu] += ((*p_t++ * tmp) >> 8) + 1;
                }
            }
        }
        printf("  a_grad   ");
        for (iqu = 0; iqu < 24; iqu++ ) {
            printf(" %d", p_grad[iqu]);
        }
        printf("\n");

    } else if (grad_mode == 1 || grad_mode == 2 || grad_mode == 3) {
        printf("  GRADQU1    %02X\n", read_bits(pdata, pos +  2, 5));
        printf("  GRADOS     %02X\n", read_bits(pdata, pos +  7, 5));
        printf("  NADJQU     %02X\n", read_bits(pdata, pos + 12, 5));
        g_nadjqus = read_bits(pdata, pos + 12, 5);
        new_pos = pos + 17;
    } else {
        printf("grad mode error\n");
        return -1;
    }
    printf("\n");

    return new_pos;
}

int decode_huffman(const CODES c, unsigned char *pdata, int start_pos)
{
    int pos = start_pos;
    int tmp;
    int i;

    /* read 1st bit */
    tmp =  read_bit(pdata, pos);

    /* check codes */
    for (int nbits = c.codes_min_bits; nbits <= c.codes_max_bits; nbits++) {
        pos++;
        tmp = tmp << 1;
        tmp += read_bit(pdata, pos);
        for (i=0; i < c.ncodes; i++) {
            if (c.p_tbl[i].code == tmp) {
                goto found;
            }
        }
    }
    puts("not found");
    return -1;
found:

    return i;
}

int dump_ldac_sfhuffman(unsigned char *pdata, int pos)
{
    int p, count, idx;
    int dif[LDAC_MAXNQUS];

    printf("  DIF       ");
    for (p = pos, count = 1; count < 24;) {
        idx = decode_huffman(codes, pdata, p);
        if (idx >= 0) {
            if (idx <= 4) {
                dif[count] = idx;
            } else {
                dif[count] = -8 + idx;
            }
            printf(" %2d", dif[count]);
            p += codes.p_tbl[idx].len;
            count++;
        } else {
            break;
        }
    }
    printf("\n");

    //dump idsf
    int val0 = g_a_idsf[0];
    int val1;
    const unsigned char *p_tbl;

    p_tbl = gaa_sfcwgt_ldac[g_sfc_weight];
    g_a_idsf[0] = val0 - p_tbl[0];

    for (int iqu = 1; iqu < 24; iqu++) {
        val1 = dif[iqu] + val0;
        g_a_idsf[iqu] = val1 - p_tbl[iqu];
        val0 = val1;
    }

    printf("  a_idsf    ");
    for (int i = 0; i < 24 /* LDAC_MAXNQUS */; i++) {
        printf(" %02X", g_a_idsf[i]);
    }
    printf("\n");

    return p - pos;
}

int dump_ldac_scalefactor(unsigned char *pdata, int pos)
{
    int sfc_bitlen, sfc_offset, hc_len;
    printf("SCALEFACTOR\n");
    printf("  SFCMODE    %02X\n", read_bits(pdata, pos +  0, 1));
    printf("  SFCBLEN    %02X\n", read_bits(pdata, pos +  1, 2));
    sfc_bitlen = 3 + read_bits(pdata, pos +  1, 2);
    printf("  IDSF       %02X\n", read_bits(pdata, pos +  3, 5));
    sfc_offset = read_bits(pdata, pos +  3, 5);
    printf("  SFCWTBL    %02X\n", read_bits(pdata, pos +  8, 3));
    g_sfc_weight = read_bits(pdata, pos +  8, 3);

    printf("  VAL0       %02X\n", read_bits(pdata, pos + 11, sfc_bitlen));
    g_a_idsf[0] = read_bits(pdata, pos + 11, sfc_bitlen) + sfc_offset;

    hc_len = dump_ldac_sfhuffman(pdata, pos + 11 + sfc_bitlen);

    printf("\n");

    return pos + 11 + sfc_bitlen + hc_len;
}

#define LDAC_MINIDWL1          1
#define LDAC_MAXIDWL1         15
#define LDAC_MAXIDWL2         15
#define LDAC_2DIMSPECBITS      3
#define LDAC_4DIMSPECBITS      7
int dump_ldac_spectrum(unsigned char *pdata, int pos)
{
    int i, iqu, idwl1, idwl2, idsp;
    int nbits = 0;
    int hqu = 24;
    int nqus = 24;
    int isp;
    int lsp, hsp;
    int nsps, wl, val;
    int *p_grad, *p_idsf, *p_addwl, *p_idwl1, *p_idwl2, *p_tmp;
    p_grad = g_a_grad;
	p_idsf = g_a_idsf;
	p_addwl = g_a_addwl;
	p_idwl1 = g_a_idwl1;
	p_idwl2 = g_a_idwl2;

    /* grad_mode == 0 */
    for (iqu = 0; iqu < hqu; iqu++) {
        for (iqu = 0; iqu < hqu; iqu++) {
            idwl1 = p_idsf[iqu] + p_grad[iqu];
            if (idwl1 < LDAC_MINIDWL1) {
                idwl1 = LDAC_MINIDWL1;
            }
            idwl2 = 0;
            if (idwl1 > LDAC_MAXIDWL1) {
                idwl2 = idwl1 - LDAC_MAXIDWL1;
                if (idwl2 > LDAC_MAXIDWL2) {
                    idwl2 = LDAC_MAXIDWL2;
                }
                idwl1 = LDAC_MAXIDWL1;
            }
            p_idwl1[iqu] = idwl1;
            p_idwl2[iqu] = idwl2;
        }
    }

    printf("  a_idwl1 a ");
    for (iqu = 0; iqu < 24 /* LDAC_MAXNQUS */; iqu++) {
        printf(" %02X", p_idwl1[iqu]);
    }
    printf("\n");

    /* use adjust  */
    int nadjqus = g_nadjqus;
	p_tmp = g_a_idwl1;
    for (iqu = 0; iqu < nqus; iqu++) {
        idwl1 = p_tmp[iqu];
        if (iqu < nadjqus) {
            idwl1++;
        }
        idwl2 = 0;
        if (idwl1 > LDAC_MAXIDWL1) {
            idwl2 = idwl1 - LDAC_MAXIDWL1;
            if (idwl2 > LDAC_MAXIDWL2) {
                idwl2 = LDAC_MAXIDWL2;
            }
            idwl1 = LDAC_MAXIDWL1;
        }
        p_idwl1[iqu] = idwl1;
        p_idwl2[iqu] = idwl2;
    }

    printf("  a_idwl1 b ");
    for (iqu = 0; iqu < 24 /* LDAC_MAXNQUS */; iqu++) {
        printf(" %02X", p_idwl1[iqu]);
    }
    printf("\n");

    printf("  wl        ");
    for (iqu = 0; iqu < nqus; iqu++) {
        lsp = ga_isp_ldac[iqu];
        hsp = ga_isp_ldac[iqu+1];
        nsps = ga_nsps_ldac[iqu];
        idwl1 = g_a_idwl1[iqu];
        wl = ga_wl_ldac[idwl1];

        if (idwl1 == 1) {
            isp = lsp;

            if (nsps == 2) {
                printf(" %2d", LDAC_2DIMSPECBITS);
            } else {
                for (i = 0; i < nsps>>2; i++, isp+=4) {
                   printf(" %2d", LDAC_4DIMSPECBITS);
                }
            }
        } else {
            for (isp = lsp; isp < hsp; isp++) {
                printf(" %2d", wl);
            }
        }
    }
    printf("\n");

    printf("SPECTRUM\n");
    printf("  S  0  8    %03X\n", read_bits(pdata, pos +  0, 8));
    return 0;
}

int main(int argc, char *argv[])
{
    int pos;
    unsigned char ldac[1024];
    FILE *infp;

    if ((infp = fopen(argv[1], "r"))==NULL) {
        printf("can't open input file\n");
        return -1;
    }

    fread(ldac, 660, 1, infp);

    pos = dump_ldac_header(ldac, 0);
    pos = dump_ldac_bandinfo(ldac, pos);
    pos = dump_ldac_gradient(ldac, pos);
    pos = dump_ldac_scalefactor(ldac, pos);
    pos = dump_ldac_spectrum(ldac, pos);

    return 0;
}

